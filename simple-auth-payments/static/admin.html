<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Wasla</title>
    <link rel="stylesheet" href="dd.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="js/i18n.js"></script>
    <script src="js/language-switcher.js"></script>
    <script src="js/page-translator.js"></script>
    <script src="js/dynamic-content-i18n.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .admin-container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #2E4275; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(46, 66, 117, 0.15); }
        .stat-card h3 { font-size: 13px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
        .stat-card .value { font-size: 32px; font-weight: 900; color: #2E4275; }
        .section { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid #f0f0f0; }
        .section h2 { margin-bottom: 20px; color: #000; font-weight: 900; font-size: 24px; text-transform: uppercase; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 700; color: #2E4275; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; }
        .btn-small { padding: 6px 12px; font-size: 13px; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px; font-weight: 600; transition: all 0.2s; }
        .btn-small:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-primary { background: #2E4275; color: white; }
        .btn-primary:hover { background: #324c8f; }
        .tabs { display: flex; gap: 16px; margin-bottom: 24px; border-bottom: 2px solid #eee; }
        .tab { padding: 12px 24px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #666; transition: all 0.2s; }
        .tab.active { color: #2E4275; border-bottom-color: #2E4275; }
        .tab:hover { color: #2E4275; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-warning { background: #fff3cd; color: #856404; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 12px; width: 80%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: #2E4275; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .preview-section { background: #f8f9fa; padding: 16px; border-radius: 8px; margin: 16px 0; }
        .preview-section h4 { margin: 0 0 12px 0; color: #2E4275; }
        .svg-preview { display: flex; align-items: center; justify-content: center; min-height: 80px; background: white; border-radius: 6px; margin-bottom: 12px; }
        .description-preview { background: white; padding: 12px; border-radius: 6px; border: 1px solid #ddd; min-height: 60px; }
        .radio-group { display: flex; gap: 16px; margin-top: 8px; }
        .radio-group label { display: flex; align-items: center; font-weight: normal; cursor: pointer; }
        .radio-group input[type="radio"] { margin-right: 6px; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="nav-container">
            <div class="logo">
                <a href="admin.html" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                    <span style="font-size: 24px; font-weight: 900; color: #2E4275;">Wasla Admin</span>
                </a>
            </div>

            <nav class="nav-links">
                <a href="admin.html">Admin Dashboard</a>
            </nav>

            <div class="nav-actions">
                <div class="lang-selector">
                    <span class="globe-icon">üåê</span>
                    <select id="languageSelect" style="border: none; background: transparent; font-weight: 600; cursor: pointer; outline: none;">
                        <option value="en">EN</option>
                        <option value="ar">üá∏üá¶ AR</option>
                    </select>
                </div>
                <span id="adminEmail" style="margin-right: 15px; font-weight: 500;"></span>
                <button class="btn btn-outline" onclick="logout()">Log out</button>
            </div>
        </div>
    </header>

    <div class="admin-container">
        <div class="stats-grid" id="statsGrid"></div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('users', this)">Users</div>
            <div class="tab" onclick="switchTab('subscriptions', this)">Subscriptions</div>
            <div class="tab" onclick="switchTab('dashboards', this)">Dashboards</div>
            <div class="tab" onclick="switchTab('payments', this)">Payments</div>
            <div class="tab" onclick="switchTab('bundles', this)">Bundles</div>
            <div class="tab" onclick="switchTab('discounts', this)">Discounts</div>
            <div class="tab" onclick="switchTab('leads', this)">Leads</div>
            <div class="tab" onclick="switchTab('backup', this)">üîí Backup</div>
        </div>

        <div id="users-tab" class="tab-content active">
            <div class="section">
                <h2>User Management</h2>
                <button onclick="showCreateUser()" class="btn-primary btn-small" style="margin-bottom: 16px;">Create New User</button>
                <table id="usersTable">
                    <thead><tr><th>ID</th><th>Email</th><th>Full Name</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="subscriptions-tab" class="tab-content">
            <div class="section">
                <h2>Active Subscriptions</h2>
                <table id="subscriptionsTable">
                    <thead><tr><th>ID</th><th>User Email</th><th>Plan</th><th>Start Date</th><th>End Date</th><th>Status</th><th>Days Left</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="dashboards-tab" class="tab-content">
            <div class="section">
                <h2>Client Dashboards</h2>
                <button onclick="showCreateDashboard()" class="btn-primary btn-small" style="margin-bottom: 16px;">Create/Update Dashboard</button>
                <table id="dashboardsTable">
                    <thead><tr><th>ID</th><th>User Email</th><th>Looker Studio URL</th><th>Created</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="payments-tab" class="tab-content">
            <div class="section">
                <h2>Payment History</h2>
                <table id="paymentsTable">
                    <thead><tr><th>ID</th><th>User</th><th>Bundle</th><th>Amount</th><th>Months</th><th>Discount</th><th>Status</th><th>Date</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="bundles-tab" class="tab-content">
            <div class="section">
                <h2>Bundle Management</h2>
                <button onclick="showCreateBundle()" class="btn-primary btn-small" style="margin-bottom: 16px;">Create New Bundle</button>
                <table id="bundlesTable">
                    <thead><tr><th>ID</th><th>Name</th><th>Price</th><th>Currency</th><th>Status</th><th>Logo</th><th>Description</th><th>Main Description</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="discounts-tab" class="tab-content">
            <div class="section">
                <h2>Discount Rules Management</h2>
                <button onclick="showCreateDiscount()" class="btn-primary btn-small" style="margin-bottom: 16px;">Create New Discount Rule</button>
                <table id="discountsTable">
                    <thead><tr><th>ID</th><th>Name</th><th>Month Range</th><th>Discount %</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="leads-tab" class="tab-content">
            <div class="section">
                <h2>Lead Management</h2>
                
                <!-- Filters Section -->
                <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; color: #2E4275; font-size: 16px;">Filters</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div>
                            <label for="statusFilter" style="font-weight: 600; display: block; margin-bottom: 4px; font-size: 13px;">Status:</label>
                            <select id="statusFilter" onchange="loadContacts()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="">All Statuses</option>
                                <option value="new">New</option>
                                <option value="contacted">Contacted</option>
                                <option value="qualified">Qualified</option>
                                <option value="converted">Converted</option>
                                <option value="not_interested">Not Interested</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="countryFilter" style="font-weight: 600; display: block; margin-bottom: 4px; font-size: 13px;">Country:</label>
                            <select id="countryFilter" onchange="loadContacts()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="">All Countries</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="referralFilter" style="font-weight: 600; display: block; margin-bottom: 4px; font-size: 13px;">Referral Source:</label>
                            <select id="referralFilter" onchange="loadContacts()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="">All Sources</option>
                                <option value="social">Social Media</option>
                                <option value="search">Search Engine</option>
                                <option value="referral">Referral</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="languageFilter" style="font-weight: 600; display: block; margin-bottom: 4px; font-size: 13px;">Language:</label>
                            <select id="languageFilter" onchange="loadContacts()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="">All Languages</option>
                                <option value="en">English</option>
                                <option value="ar">Arabic</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="marketingFilter" style="font-weight: 600; display: block; margin-bottom: 4px; font-size: 13px;">Marketing Consent:</label>
                            <select id="marketingFilter" onchange="loadContacts()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="">All</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="assignmentFilter" style="font-weight: 600; display: block; margin-bottom: 4px; font-size: 13px;">Assigned To:</label>
                            <select id="assignmentFilter" onchange="loadContacts()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="">All Leads</option>
                                <option value="unassigned">Unassigned</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="startDateFilter" style="font-weight: 600; display: block; margin-bottom: 4px; font-size: 13px;">From Date:</label>
                            <input type="date" id="startDateFilter" onchange="loadContacts()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                        
                        <div>
                            <label for="endDateFilter" style="font-weight: 600; display: block; margin-bottom: 4px; font-size: 13px;">To Date:</label>
                            <input type="date" id="endDateFilter" onchange="loadContacts()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                        
                        <div style="display: flex; align-items: flex-end; gap: 8px;">
                            <button onclick="clearFilters()" class="btn-small btn-warning" style="flex: 1;">Clear Filters</button>
                            <button onclick="exportContacts()" class="btn-small btn-success" style="flex: 1;">üì• Export CSV</button>
                        </div>
                    </div>
                    
                    <div id="filterSummary" style="margin-top: 12px; padding: 8px; background: white; border-radius: 6px; font-size: 13px; color: #666; display: none;">
                        <strong>Active Filters:</strong> <span id="filterSummaryText"></span>
                    </div>
                </div>
                
                <table id="contactsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Business</th>
                            <th>Locations</th>
                            <th>Country</th>
                            <th>Referral</th>
                            <th>Status</th>
                            <th>Assigned To</th>
                            <th>Marketing</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Backup Tab -->
        <div id="backup-tab" class="tab-content">
            <div class="section">
                <h2>üîí Database Backup & Restore</h2>
                <p style="color: #666; margin-bottom: 24px;">Create backups of your database and restore from previous backups. Only Admin and Technical users can access this feature.</p>
                
                <!-- Backup Actions -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                    <h3 style="margin: 0 0 16px 0; color: #2E4275; font-size: 18px;">Create New Backup</h3>
                    <button onclick="createBackup()" class="btn-primary btn-small" style="padding: 10px 20px; font-size: 14px;">
                        üì¶ Create Backup Now
                    </button>
                    <p style="margin: 12px 0 0 0; font-size: 13px; color: #666;">
                        Creates a timestamped backup of the current database. Old backups are automatically cleaned up (keeps last 10).
                    </p>
                </div>
                
                <!-- Backup List -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0; color: #2E4275; font-size: 18px;">Available Backups</h3>
                        <button onclick="loadBackups()" class="btn-small btn-warning">üîÑ Refresh List</button>
                    </div>
                    
                    <div id="backupsList" style="background: white; border: 1px solid #ddd; border-radius: 8px; min-height: 200px;">
                        <p style="padding: 40px; text-align: center; color: #999;">Loading backups...</p>
                    </div>
                </div>
                
                <!-- Warning -->
                <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 16px; border-radius: 8px; margin-top: 24px;">
                    <strong style="color: #856404;">‚ö†Ô∏è Important:</strong>
                    <ul style="margin: 8px 0 0 20px; color: #856404;">
                        <li>Restoring a backup will replace your current database</li>
                        <li>A safety backup is created before restore</li>
                        <li>You may need to restart the application after restore</li>
                        <li>Backups are stored locally and not included in deployments</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Bundle Modal -->
    <div id="bundleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Create New Bundle</h2>
                <span class="close" onclick="closeBundleModal()">&times;</span>
            </div>
            
            <form id="bundleForm">
                <input type="hidden" id="bundleId" value="">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="bundleName">Bundle Name *</label>
                        <input type="text" id="bundleName" required>
                    </div>
                    <div class="form-group">
                        <label for="bundlePrice">Price (USD) *</label>
                        <input type="number" id="bundlePrice" step="0.01" min="0" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="bundleCurrency">Currency</label>
                        <select id="bundleCurrency">
                            <option value="usd">USD</option>
                            <option value="sar">SAR</option>
                            <option value="eur">EUR</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bundleTier">Tier Level</label>
                        <select id="bundleTier">
                            <option value="1">1 - Basic</option>
                            <option value="2">2 - Pro</option>
                            <option value="3">3 - Premium</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="bundleLogo">Logo Type</label>
                    <select id="bundleLogo" onchange="updatePreview()">
                        <option value="silver">Silver Medal</option>
                        <option value="gold">Gold Crown</option>
                        <option value="diamond">Diamond Premium</option>
                    </select>
                </div>
                
                <div class="preview-section">
                    <h4>Logo Preview</h4>
                    <div id="svgPreview" class="svg-preview">Loading...</div>
                </div>
                
                <div class="form-group">
                    <label>Description Type</label>
                    <div class="radio-group">
                        <label><input type="radio" name="descType" value="predefined" checked onchange="toggleDescriptionType()"> Predefined</label>
                        <label><input type="radio" name="descType" value="custom" onchange="toggleDescriptionType()"> Custom</label>
                    </div>
                </div>
                
                <div class="form-group" id="predefinedDescGroup">
                    <label for="bundleDescPredefined">Predefined Description</label>
                    <select id="bundleDescPredefined" onchange="updatePreview()">
                        <option value="basic-silver">Basic Silver Features</option>
                        <option value="upper-gold">Upper Gold Features</option>
                        <option value="advanced-diamond">Advanced Diamond Features</option>
                    </select>
                </div>
                
                <div class="form-group" id="customDescGroup" style="display: none;">
                    <label for="bundleDescCustom">Custom Description</label>
                    <textarea id="bundleDescCustom" placeholder="Enter custom description text..." onchange="updatePreview()"></textarea>
                </div>
                
                <div class="preview-section">
                    <h4>Description Preview</h4>
                    <div id="descriptionPreview" class="description-preview">Loading...</div>
                </div>
                
                <div class="form-group">
                    <label for="bundleMainDesc">Main Description</label>
                    <textarea id="bundleMainDesc" placeholder="Enter main description for this bundle..."></textarea>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn-small btn-danger" onclick="closeBundleModal()">Cancel</button>
                    <button type="submit" class="btn-small btn-primary">Save Bundle</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Create New User</h2>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            
            <form id="userForm">
                <input type="hidden" id="userId" value="">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="userEmail">Email Address *</label>
                        <input type="email" id="userEmail" required placeholder="user@example.com">
                    </div>
                    <div class="form-group">
                        <label for="userFullName">Full Name</label>
                        <input type="text" id="userFullName" placeholder="John Doe">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="userPassword">Password *</label>
                        <input type="password" id="userPassword" required placeholder="Enter secure password">
                        <small style="color: #666; font-size: 12px;">Minimum 6 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="userRole">Role</label>
                        <select id="userRole" onchange="toggleSubscriptionFields()">
                            <option value="user">Regular User</option>
                            <option value="admin">Administrator</option>
                            <option value="salesman">Salesman</option>
                            <option value="accountant">Accountant</option>
                            <option value="technical">Technical</option>
                        </select>
                    </div>
                </div>
                
                <!-- Subscription-related fields (only for regular users) -->
                <div id="subscriptionFields">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userStatus">Account Status</label>
                            <select id="userStatus">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userAccessOverride">Access Override</label>
                            <select id="userAccessOverride">
                                <option value="false">Require Subscription</option>
                                <option value="true">Grant Free Access</option>
                            </select>
                            <small style="color: #666; font-size: 12px;">Allow access without subscription</small>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn-small btn-danger" onclick="closeUserModal()">Cancel</button>
                    <button type="submit" class="btn-small btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard Modal -->
    <div id="dashboardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="dashboardModalTitle">Create/Update Dashboard</h2>
                <span class="close" onclick="closeDashboardModal()">&times;</span>
            </div>
            
            <form id="dashboardForm">
                <input type="hidden" id="dashboardId" value="">
                <input type="hidden" id="dashboardUserId" value="">
                
                <div class="form-group">
                    <label for="dashboardUserSelect">Select User *</label>
                    <select id="dashboardUserSelect" required onchange="updateDashboardUserInfo()">
                        <option value="">-- Select a user --</option>
                    </select>
                    <small style="color: #666; font-size: 12px;">Choose which user this dashboard belongs to</small>
                </div>
                
                <div class="form-group" id="userInfoSection" style="display: none;">
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #ddd;">
                        <h4 style="margin: 0 0 8px 0; color: #2E4275;">User Information</h4>
                        <p style="margin: 4px 0;"><strong>Email:</strong> <span id="selectedUserEmail">-</span></p>
                        <p style="margin: 4px 0;"><strong>Name:</strong> <span id="selectedUserName">-</span></p>
                        <p style="margin: 4px 0;"><strong>Role:</strong> <span id="selectedUserRole">-</span></p>
                        <p style="margin: 4px 0;"><strong>Status:</strong> <span id="selectedUserStatus">-</span></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="dashboardUrl">Looker Studio URL *</label>
                    <input type="url" id="dashboardUrl" required placeholder="https://lookerstudio.google.com/reporting/...">
                    <small style="color: #666; font-size: 12px;">Full URL to the Looker Studio dashboard</small>
                </div>
                
                <div class="form-group">
                    <label for="dashboardNotes">Notes (Optional)</label>
                    <textarea id="dashboardNotes" placeholder="Add any notes about this dashboard..." rows="3"></textarea>
                </div>
                
                <div class="preview-section">
                    <h4>URL Preview</h4>
                    <div id="urlPreview" style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #ddd; font-family: monospace; font-size: 12px; word-break: break-all; color: #666;">
                        Enter URL above to see preview
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn-small btn-danger" onclick="closeDashboardModal()">Cancel</button>
                    <button type="submit" class="btn-small btn-primary">Save Dashboard</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contact Detail Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Contact Details</h2>
                <span class="close" onclick="closeContactModal()">&times;</span>
            </div>
            
            <div id="contactDetailContent">
                <!-- Contact Information -->
                <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 12px 0; color: #2E4275;">Contact Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div><strong>Name:</strong> <span id="contactName"></span></div>
                        <div><strong>Email:</strong> <span id="contactEmail"></span></div>
                        <div><strong>Phone:</strong> <span id="contactPhone"></span></div>
                        <div><strong>Country:</strong> <span id="contactCountry"></span></div>
                        <div><strong>Business:</strong> <span id="contactBusiness"></span></div>
                        <div><strong>Locations:</strong> <span id="contactLocations"></span></div>
                        <div><strong>Referral:</strong> <span id="contactReferral"></span></div>
                        <div><strong>Language:</strong> <span id="contactLanguage"></span></div>
                        <div><strong>Marketing Consent:</strong> <span id="contactMarketing"></span></div>
                        <div><strong>Submitted:</strong> <span id="contactCreated"></span></div>
                    </div>
                </div>
                
                <!-- Status Update -->
                <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 12px 0; color: #2E4275;">Update Status</h3>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <label for="contactStatusSelect" style="font-weight: 600;">Current Status:</label>
                        <select id="contactStatusSelect" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; flex: 1;">
                            <option value="new">New</option>
                            <option value="contacted">Contacted</option>
                            <option value="qualified">Qualified</option>
                            <option value="converted">Converted</option>
                            <option value="not_interested">Not Interested</option>
                        </select>
                        <button onclick="updateContactStatus()" class="btn-small btn-primary">Update Status</button>
                    </div>
                </div>
                
                <!-- Lead Assignment Section -->
                <div id="assignmentSection" style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px; display: none;">
                    <h3 style="margin: 0 0 12px 0; color: #2E4275;">Lead Assignment</h3>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <label for="assignedSalesman" style="font-weight: 600;">Assigned To:</label>
                        <select id="assignedSalesman" onchange="assignLead()" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; flex: 1;">
                            <option value="">Unassigned</option>
                            <!-- Salesmen options will be populated dynamically -->
                        </select>
                    </div>
                    <small style="color: #666; font-size: 12px; margin-top: 8px; display: block;">Assign this lead to a salesman for follow-up</small>
                </div>
                
                <!-- Notes Section -->
                <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 12px 0; color: #2E4275;">Notes</h3>
                    <div id="contactNotesList" style="max-height: 300px; overflow-y: auto; margin-bottom: 16px;">
                        <!-- Notes will be loaded here -->
                    </div>
                    
                    <!-- Add Note Form -->
                    <div style="border-top: 1px solid #ddd; padding-top: 16px;">
                        <h4 style="margin: 0 0 8px 0; color: #333;">Add New Note</h4>
                        <textarea id="newNoteText" placeholder="Enter your note here..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical; min-height: 80px; margin-bottom: 8px;"></textarea>
                        <button onclick="addContactNote()" class="btn-small btn-success">Add Note</button>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn-small btn-primary" onclick="closeContactModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Discount Modal -->
    <div id="discountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="discountModalTitle">Create New Discount Rule</h2>
                <span class="close" onclick="closeDiscountModal()">&times;</span>
            </div>
            
            <form id="discountForm">
                <input type="hidden" id="discountId" value="">
                
                <div class="form-group">
                    <label for="discountName">Rule Name *</label>
                    <input type="text" id="discountName" required placeholder="e.g., 6-Month Discount">
                    <small style="color: #666; font-size: 12px;">Descriptive name for this discount rule</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="discountMinMonths">Minimum Months *</label>
                        <input type="number" id="discountMinMonths" required min="1" max="120" placeholder="6">
                        <small style="color: #666; font-size: 12px;">Minimum subscription length</small>
                    </div>
                    <div class="form-group">
                        <label for="discountMaxMonths">Maximum Months</label>
                        <input type="number" id="discountMaxMonths" min="1" max="120" placeholder="12">
                        <small style="color: #666; font-size: 12px;">Leave empty for unlimited</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="discountPercentage">Discount Percentage *</label>
                        <input type="number" id="discountPercentage" required min="0" max="100" step="1" placeholder="10">
                        <small style="color: #666; font-size: 12px;">Percentage discount (0-100)</small>
                    </div>
                    <div class="form-group">
                        <label for="discountStatus">Status</label>
                        <select id="discountStatus">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="preview-section">
                    <h4>Rule Preview</h4>
                    <div id="discountPreview" style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #ddd; color: #333;">
                        Enter details above to see preview
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn-small btn-danger" onclick="closeDiscountModal()">Cancel</button>
                    <button type="submit" class="btn-small btn-primary">Save Discount Rule</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Automatically detect the API base URL based on current location
        const API_BASE_URL = window.location.origin;
        const token = localStorage.getItem('access_token');
        if (!token) { window.location.href = 'login.html'; }
        let currentTab = 'users';

        function switchTab(tab, targetElement) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // If called from onclick, use event.target, otherwise find the tab element
            if (targetElement) {
                targetElement.classList.add('active');
            } else {
                // Find the tab element by matching the onclick attribute
                const tabElement = document.querySelector(`.tab[onclick*="${tab}"]`);
                if (tabElement) {
                    tabElement.classList.add('active');
                }
            }
            
            document.getElementById(tab + '-tab').classList.add('active');
        }

        async function fetchAdminData() {
            try {
                // Fetch current user's role first
                const userResponse = await fetch(`${API_BASE_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
                const user = await userResponse.json();
                document.getElementById('adminEmail').textContent = user.email;
                
                // Initialize role-based UI
                initializeRoleBasedUI(user.role);
                
                // Only fetch stats if user is admin
                if (user.role === 'admin') {
                    const statsResponse = await fetch(`${API_BASE_URL}/admin/stats`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (statsResponse.ok) {
                        const stats = await statsResponse.json();
                        document.getElementById('statsGrid').innerHTML = `
                            <div class="stat-card"><h3>Total Users</h3><div class="value">${stats.total_users}</div></div>
                            <div class="stat-card"><h3>Active Users</h3><div class="value">${stats.active_users}</div></div>
                            <div class="stat-card"><h3>Total Payments</h3><div class="value">${stats.total_payments}</div></div>
                            <div class="stat-card"><h3>Successful Payments</h3><div class="value">${stats.successful_payments}</div></div>
                            <div class="stat-card"><h3>Total Revenue</h3><div class="value">${stats.total_revenue_usd.toFixed(2)}</div></div>
                        `;
                    }
                } else {
                    // Hide stats grid for non-admin users
                    document.getElementById('statsGrid').style.display = 'none';
                }
                
                // Load data based on role permissions
                if (user.role === 'admin') {
                    await loadUsers();
                    await loadSubscriptions();
                    await loadDashboards();
                    await loadPayments();
                    await loadBundles();
                    await loadDiscounts();
                    await loadContacts();
                } else if (user.role === 'accountant') {
                    await loadContacts();
                } else if (user.role === 'salesman') {
                    await loadContacts();
                    // Auto-switch to leads tab for salesmen
                    switchTab('leads');
                } else if (user.role === 'technical') {
                    await loadUsers();
                    await loadDashboards();
                }
            } catch (error) { 
                console.error('Error:', error); 
                alert('Error loading admin data.'); 
            }
        }

        async function loadUsers() {
            const response = await fetch(`${API_BASE_URL}/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } });
            const users = await response.json();
            
            // Helper function to get badge class for role
            const getRoleBadgeClass = (role) => {
                const badgeMap = {
                    'admin': 'badge-warning',
                    'accountant': 'badge-success',
                    'salesman': 'badge-success',
                    'technical': 'badge-success',
                    'user': 'badge-success'
                };
                return badgeMap[role] || 'badge-success';
            };
            
            // Helper function to get role display name
            const getRoleDisplayName = (role) => {
                const roleNames = {
                    'admin': 'Admin',
                    'accountant': 'Accountant',
                    'salesman': 'Salesman',
                    'technical': 'Technical',
                    'user': 'User'
                };
                return roleNames[role] || role;
            };
            
            document.querySelector('#usersTable tbody').innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td><td>${user.email}</td><td>${user.full_name || '-'}</td>
                    <td><span class="badge ${getRoleBadgeClass(user.role)}">${getRoleDisplayName(user.role)}</span></td>
                    <td><span class="badge ${user.is_active ? 'badge-success' : 'badge-danger'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn-small btn-primary" onclick="editUser(${user.id})">Edit</button>
                        <button class="btn-small btn-warning" onclick="toggleUserRole(${user.id}, '${user.role}')">Change Role</button>
                        <button class="btn-small ${user.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleUserStatus(${user.id}, ${!user.is_active})">${user.is_active ? 'Deactivate' : 'Activate'}</button>
                        <button class="btn-small btn-primary" onclick="toggleAccessOverride(${user.id}, ${user.allow_access_without_subscription || false})">${user.allow_access_without_subscription ? 'üîì Remove' : 'üîí Grant'}</button>
                        <button class="btn-small btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadSubscriptions() {
            const response = await fetch(`${API_BASE_URL}/admin/subscriptions`, { headers: { 'Authorization': `Bearer ${token}` } });
            const subscriptions = await response.json();
            document.querySelector('#subscriptionsTable tbody').innerHTML = subscriptions.map(sub => {
                const endDate = new Date(sub.end_date); const now = new Date();
                const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                const isActive = sub.is_active && daysLeft > 0;
                return `<tr><td>${sub.id}</td><td>${sub.user_email}</td><td>${sub.bundle_name}</td><td>${new Date(sub.start_date).toLocaleDateString()}</td><td>${endDate.toLocaleDateString()}</td><td><span class="badge ${isActive ? 'badge-success' : 'badge-danger'}">${isActive ? 'Active' : 'Expired'}</span></td><td>${isActive ? daysLeft + ' days' : '-'}</td></tr>`;
            }).join('');
        }

        async function loadDashboards() {
            const response = await fetch(`${API_BASE_URL}/admin/dashboards`, { headers: { 'Authorization': `Bearer ${token}` } });
            const dashboards = await response.json();
            document.querySelector('#dashboardsTable tbody').innerHTML = dashboards.map(d => `
                <tr><td>${d.id}</td><td>${d.user_email}</td><td><a href="${d.looker_studio_url}" target="_blank" style="color: #2E4275;">${d.looker_studio_url.substring(0, 50)}...</a></td><td>${new Date(d.created_at).toLocaleDateString()}</td><td><button class="btn-small btn-warning" onclick="editDashboard(${d.user_id}, '${d.looker_studio_url}')">Edit</button></td></tr>
            `).join('');
        }

        async function loadPayments() {
            const response = await fetch(`${API_BASE_URL}/admin/payments`, { headers: { 'Authorization': `Bearer ${token}` } });
            const payments = await response.json();
            document.querySelector('#paymentsTable tbody').innerHTML = payments.map(p => `
                <tr><td>${p.id}</td><td>${p.user_email}</td><td>${p.bundle_name}</td><td>${(p.amount_cents / 100).toFixed(2)}</td><td>${p.months_purchased || 1}</td><td>${p.discount_percentage || 0}%</td><td><span class="badge ${p.status === 'succeeded' ? 'badge-success' : 'badge-warning'}">${p.status}</span></td><td>${new Date(p.created_at).toLocaleString()}</td></tr>
            `).join('');
        }

        async function loadDiscounts() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/discount-rules`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const discounts = await response.json();
                document.querySelector('#discountsTable tbody').innerHTML = discounts.map(d => {
                    const maxDisplay = d.max_months ? d.max_months : '‚àû';
                    const rangeDisplay = d.min_months === d.max_months ? `${d.min_months}` : `${d.min_months}-${maxDisplay}`;
                    const createdDate = d.created_at ? new Date(d.created_at).toLocaleDateString() : 'N/A';
                    
                    return `
                        <tr>
                            <td>${d.id}</td>
                            <td>${d.name}</td>
                            <td>${rangeDisplay} months</td>
                            <td>${d.discount_percentage}%</td>
                            <td><span class="badge ${d.is_active ? 'badge-success' : 'badge-danger'}">${d.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>${createdDate}</td>
                            <td>
                                <button class="btn-small btn-primary" onclick="editDiscount(${d.id})">Edit</button>
                                <button class="btn-small ${d.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleDiscountStatus(${d.id}, ${!d.is_active})">${d.is_active ? 'Deactivate' : 'Activate'}</button>
                                <button class="btn-small btn-danger" onclick="deleteDiscount(${d.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading discounts:', error);
                document.querySelector('#discountsTable tbody').innerHTML = '<tr><td colspan="7">Error loading discount rules</td></tr>';
            }
        }
        
        function showCreateDiscount() {
            document.getElementById('discountModalTitle').textContent = 'Create New Discount Rule';
            document.getElementById('discountId').value = '';
            document.getElementById('discountForm').reset();
            document.getElementById('discountModal').style.display = 'block';
            updateDiscountPreview();
        }
        
        function editDiscount(discountId) {
            fetch(`${API_BASE_URL}/admin/discount-rules`, { headers: { 'Authorization': `Bearer ${token}` } })
                .then(response => response.json())
                .then(discounts => {
                    const discount = discounts.find(d => d.id === discountId);
                    if (!discount) {
                        alert('Discount rule not found');
                        return;
                    }
                    
                    document.getElementById('discountModalTitle').textContent = 'Edit Discount Rule';
                    document.getElementById('discountId').value = discount.id;
                    document.getElementById('discountName').value = discount.name;
                    document.getElementById('discountMinMonths').value = discount.min_months;
                    document.getElementById('discountMaxMonths').value = discount.max_months || '';
                    document.getElementById('discountPercentage').value = discount.discount_percentage;
                    document.getElementById('discountStatus').value = discount.is_active.toString();
                    
                    document.getElementById('discountModal').style.display = 'block';
                    updateDiscountPreview();
                })
                .catch(error => {
                    console.error('Error loading discount:', error);
                    alert('Error loading discount data');
                });
        }
        
        function closeDiscountModal() {
            document.getElementById('discountModal').style.display = 'none';
        }
        
        function updateDiscountPreview() {
            const minMonths = document.getElementById('discountMinMonths').value;
            const maxMonths = document.getElementById('discountMaxMonths').value;
            const percentage = document.getElementById('discountPercentage').value;
            const name = document.getElementById('discountName').value;
            
            let preview = 'Enter details above to see preview';
            
            if (minMonths && percentage) {
                const rangeText = maxMonths ? 
                    (minMonths === maxMonths ? `${minMonths} months` : `${minMonths}-${maxMonths} months`) :
                    `${minMonths}+ months`;
                
                preview = `${name || 'Discount Rule'}: ${rangeText} = ${percentage}% OFF`;
            }
            
            document.getElementById('discountPreview').textContent = preview;
        }
        
        async function toggleDiscountStatus(discountId, newStatus) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/discount-rules/${discountId}?is_active=${newStatus}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    await loadDiscounts();
                } else {
                    alert('Error updating discount status');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating discount status');
            }
        }
        
        async function deleteDiscount(discountId) {
            if (!confirm('Delete this discount rule? This action cannot be undone.')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/discount-rules/${discountId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    await loadDiscounts();
                } else {
                    alert('Error deleting discount rule');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting discount rule');
            }
        }
        
        // Add event listeners for discount preview updates
        document.addEventListener('DOMContentLoaded', function() {
            const discountInputs = ['discountName', 'discountMinMonths', 'discountMaxMonths', 'discountPercentage'];
            discountInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateDiscountPreview);
                }
            });
        });
        
        // Handle discount form submission
        document.addEventListener('DOMContentLoaded', function() {
            const discountForm = document.getElementById('discountForm');
            if (discountForm) {
                discountForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const discountId = document.getElementById('discountId').value;
                    const isEdit = discountId !== '';
                    
                    const formData = {
                        name: document.getElementById('discountName').value,
                        min_months: parseInt(document.getElementById('discountMinMonths').value),
                        discount_percentage: parseInt(document.getElementById('discountPercentage').value),
                        is_active: document.getElementById('discountStatus').value === 'true'
                    };
                    
                    const maxMonths = document.getElementById('discountMaxMonths').value;
                    if (maxMonths) {
                        formData.max_months = parseInt(maxMonths);
                    }
                    
                    try {
                        let response;
                        if (isEdit) {
                            const params = new URLSearchParams(formData);
                            response = await fetch(`${API_BASE_URL}/admin/discount-rules/${discountId}?${params}`, {
                                method: 'PUT',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                        } else {
                            const params = new URLSearchParams(formData);
                            response = await fetch(`${API_BASE_URL}/admin/discount-rules?${params}`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                        }
                        
                        if (response.ok) {
                            alert(isEdit ? 'Discount rule updated successfully!' : 'Discount rule created successfully!');
                            closeDiscountModal();
                            await loadDiscounts();
                        } else {
                            const error = await response.json();
                            alert('Error: ' + (error.detail || 'Failed to save discount rule'));
                        }
                    } catch (error) {
                        console.error('Error saving discount:', error);
                        alert('Error saving discount rule');
                    }
                });
            }
        });

        async function loadBundles() {
            const response = await fetch(`${API_BASE_URL}/admin/bundles`, { headers: { 'Authorization': `Bearer ${token}` } });
            const bundles = await response.json();
            document.querySelector('#bundlesTable tbody').innerHTML = bundles.map(b => `
                <tr>
                    <td>${b.id}</td>
                    <td>${b.name}</td>
                    <td>${(b.price_cents / 100).toFixed(2)}</td>
                    <td>${b.currency.toUpperCase()}</td>
                    <td><span class="badge ${b.is_active ? 'badge-success' : 'badge-danger'}">${b.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td><span class="badge badge-warning">${b.logo_type || 'silver'}</span></td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${b.description || 'No description'}">${b.description || 'No description'}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${b.main_description || 'No main description'}">${b.main_description || 'No main description'}</td>
                    <td>
                        <button class="btn-small btn-warning" onclick="editBundle(${b.id})">Edit</button>
                        <button class="btn-small ${b.is_active ? 'btn-danger' : 'btn-success'}" onclick="toggleBundleStatus(${b.id}, ${!b.is_active})">${b.is_active ? 'Deactivate' : 'Activate'}</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadContacts() {
            try {
                // Build URL with all filters
                let url = `${API_BASE_URL}/contacts/admin/contacts?`;
                const params = [];
                
                const statusFilter = document.getElementById('statusFilter').value;
                const countryFilter = document.getElementById('countryFilter').value;
                const referralFilter = document.getElementById('referralFilter').value;
                const languageFilter = document.getElementById('languageFilter').value;
                const marketingFilter = document.getElementById('marketingFilter').value;
                const assignmentFilter = document.getElementById('assignmentFilter').value;
                const startDateFilter = document.getElementById('startDateFilter').value;
                const endDateFilter = document.getElementById('endDateFilter').value;
                
                if (statusFilter) params.push(`status=${statusFilter}`);
                if (countryFilter) params.push(`country=${encodeURIComponent(countryFilter)}`);
                if (referralFilter) params.push(`referral_source=${referralFilter}`);
                if (languageFilter) params.push(`language_preference=${languageFilter}`);
                if (marketingFilter) params.push(`marketing_consent=${marketingFilter}`);
                if (assignmentFilter) params.push(`assigned_to=${assignmentFilter}`);
                if (startDateFilter) params.push(`start_date=${startDateFilter}`);
                if (endDateFilter) params.push(`end_date=${endDateFilter}`);
                
                if (params.length > 0) {
                    url += params.join('&');
                }
                
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const contacts = await response.json();
                
                // Update filter summary
                updateFilterSummary();
                
                // Populate country filter with unique countries
                populateCountryFilter(contacts);
                
                // Populate assignment filter with salesmen
                await populateAssignmentFilter();
                
                // Sort by created_at descending (newest first)
                contacts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                document.querySelector('#contactsTable tbody').innerHTML = contacts.map(c => {
                    const createdDate = new Date(c.created_at).toLocaleDateString();
                    const fullName = `${c.first_name} ${c.last_name}`;
                    const phone = `${c.country_code} ${c.phone}`;
                    
                    // Status badge styling
                    let statusBadge = 'badge-warning';
                    if (c.status === 'converted') statusBadge = 'badge-success';
                    else if (c.status === 'not_interested') statusBadge = 'badge-danger';
                    else if (c.status === 'qualified') statusBadge = 'badge-success';
                    
                    // Assigned To display
                    let assignedTo = '<span class="badge badge-warning">Unassigned</span>';
                    if (c.assigned_to && c.assigned_to.full_name) {
                        assignedTo = `<span class="badge badge-success">${c.assigned_to.full_name}</span>`;
                    } else if (c.assigned_to && c.assigned_to.email) {
                        assignedTo = `<span class="badge badge-success">${c.assigned_to.email}</span>`;
                    }
                    
                    return `
                        <tr style="cursor: pointer;" onclick="showContactDetail(${c.id})">
                            <td>${c.id}</td>
                            <td>${createdDate}</td>
                            <td>${fullName}</td>
                            <td>${c.email}</td>
                            <td>${phone}</td>
                            <td>${c.business_name}</td>
                            <td>${c.num_locations}</td>
                            <td>${c.country}</td>
                            <td>${c.referral_source}</td>
                            <td><span class="badge ${statusBadge}">${c.status}</span></td>
                            <td>${assignedTo}</td>
                            <td><span class="badge ${c.marketing_consent ? 'badge-success' : 'badge-danger'}">${c.marketing_consent ? 'Yes' : 'No'}</span></td>
                        </tr>
                    `;
                }).join('');
                
                // Show count
                if (contacts.length === 0) {
                    document.querySelector('#contactsTable tbody').innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px; color: #666;">No contacts found matching the filters</td></tr>';
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
                document.querySelector('#contactsTable tbody').innerHTML = '<tr><td colspan="12">Error loading contacts</td></tr>';
            }
        }
        
        function populateCountryFilter(contacts) {
            const countryFilter = document.getElementById('countryFilter');
            const currentValue = countryFilter.value;
            
            // Get unique countries from contacts
            const countries = [...new Set(contacts.map(c => c.country))].sort();
            
            // Rebuild options
            countryFilter.innerHTML = '<option value="">All Countries</option>';
            countries.forEach(country => {
                countryFilter.innerHTML += `<option value="${country}">${country}</option>`;
            });
            
            // Restore previous selection if it exists
            if (currentValue && countries.includes(currentValue)) {
                countryFilter.value = currentValue;
            }
        }
        
        async function populateAssignmentFilter() {
            const assignmentFilter = document.getElementById('assignmentFilter');
            const currentValue = assignmentFilter.value;
            
            // Only populate if user has permission to see assignments
            if (!window.userPermissions || !window.userPermissions.canAssignLeads) {
                return;
            }
            
            try {
                // Fetch salesmen list
                const response = await fetch(`${API_BASE_URL}/admin/salesmen`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const salesmen = await response.json();
                    
                    // Rebuild options
                    assignmentFilter.innerHTML = '<option value="">All Leads</option>';
                    assignmentFilter.innerHTML += '<option value="unassigned">Unassigned</option>';
                    
                    salesmen.forEach(salesman => {
                        const displayName = salesman.full_name || salesman.email;
                        assignmentFilter.innerHTML += `<option value="${salesman.id}">${displayName}</option>`;
                    });
                    
                    // Restore previous selection if it exists
                    if (currentValue) {
                        assignmentFilter.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('Error loading salesmen for filter:', error);
            }
        }
        
        function updateFilterSummary() {
            const statusFilter = document.getElementById('statusFilter').value;
            const countryFilter = document.getElementById('countryFilter').value;
            const referralFilter = document.getElementById('referralFilter').value;
            const languageFilter = document.getElementById('languageFilter').value;
            const marketingFilter = document.getElementById('marketingFilter').value;
            const assignmentFilter = document.getElementById('assignmentFilter').value;
            const startDateFilter = document.getElementById('startDateFilter').value;
            const endDateFilter = document.getElementById('endDateFilter').value;
            
            const filters = [];
            if (statusFilter) filters.push(`Status: ${statusFilter}`);
            if (countryFilter) filters.push(`Country: ${countryFilter}`);
            if (referralFilter) filters.push(`Referral: ${referralFilter}`);
            if (languageFilter) filters.push(`Language: ${languageFilter}`);
            if (marketingFilter) filters.push(`Marketing: ${marketingFilter === 'true' ? 'Yes' : 'No'}`);
            if (assignmentFilter) {
                if (assignmentFilter === 'unassigned') {
                    filters.push('Assignment: Unassigned');
                } else {
                    const assignmentSelect = document.getElementById('assignmentFilter');
                    const selectedOption = assignmentSelect.options[assignmentSelect.selectedIndex];
                    filters.push(`Assigned To: ${selectedOption.text}`);
                }
            }
            if (startDateFilter) filters.push(`From: ${startDateFilter}`);
            if (endDateFilter) filters.push(`To: ${endDateFilter}`);
            
            const filterSummary = document.getElementById('filterSummary');
            const filterSummaryText = document.getElementById('filterSummaryText');
            
            if (filters.length > 0) {
                filterSummaryText.textContent = filters.join(' | ');
                filterSummary.style.display = 'block';
            } else {
                filterSummary.style.display = 'none';
            }
        }
        
        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('countryFilter').value = '';
            document.getElementById('referralFilter').value = '';
            document.getElementById('languageFilter').value = '';
            document.getElementById('marketingFilter').value = '';
            document.getElementById('assignmentFilter').value = '';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            loadContacts();
        }
        
        async function exportContacts() {
            try {
                // Build URL with all filters
                let url = `${API_BASE_URL}/contacts/admin/contacts/export?`;
                const params = [];
                
                const statusFilter = document.getElementById('statusFilter').value;
                const countryFilter = document.getElementById('countryFilter').value;
                const referralFilter = document.getElementById('referralFilter').value;
                const languageFilter = document.getElementById('languageFilter').value;
                const marketingFilter = document.getElementById('marketingFilter').value;
                const assignmentFilter = document.getElementById('assignmentFilter').value;
                const startDateFilter = document.getElementById('startDateFilter').value;
                const endDateFilter = document.getElementById('endDateFilter').value;
                
                if (statusFilter) params.push(`status=${statusFilter}`);
                if (countryFilter) params.push(`country=${encodeURIComponent(countryFilter)}`);
                if (referralFilter) params.push(`referral_source=${referralFilter}`);
                if (languageFilter) params.push(`language_preference=${languageFilter}`);
                if (marketingFilter) params.push(`marketing_consent=${marketingFilter}`);
                if (assignmentFilter) params.push(`assigned_to=${assignmentFilter}`);
                if (startDateFilter) params.push(`start_date=${startDateFilter}`);
                if (endDateFilter) params.push(`end_date=${endDateFilter}`);
                
                if (params.length > 0) {
                    url += params.join('&');
                }
                
                // Fetch the CSV file
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // Get the filename from Content-Disposition header
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'contact_requests.csv';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // Create blob and download
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                
                // Show success message
                alert('CSV export downloaded successfully!');
            } catch (error) {
                console.error('Error exporting contacts:', error);
                alert('Error exporting contacts. Please try again.');
            }
        }

        let currentContactId = null;

        async function showContactDetail(contactId) {
            try {
                currentContactId = contactId;
                
                // Fetch contact details with notes
                const response = await fetch(`${API_BASE_URL}/contacts/admin/contacts/${contactId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const contact = await response.json();
                
                // Populate contact information
                document.getElementById('contactName').textContent = `${contact.first_name} ${contact.last_name}`;
                document.getElementById('contactEmail').textContent = contact.email;
                document.getElementById('contactPhone').textContent = `${contact.country_code} ${contact.phone}`;
                document.getElementById('contactCountry').textContent = contact.country;
                document.getElementById('contactBusiness').textContent = contact.business_name;
                document.getElementById('contactLocations').textContent = contact.num_locations;
                document.getElementById('contactReferral').textContent = contact.referral_source;
                document.getElementById('contactLanguage').textContent = contact.language_preference;
                document.getElementById('contactMarketing').textContent = contact.marketing_consent ? 'Yes' : 'No';
                document.getElementById('contactCreated').textContent = new Date(contact.created_at).toLocaleString();
                
                // Set current status
                document.getElementById('contactStatusSelect').value = contact.status;
                
                // Display notes
                displayContactNotes(contact.notes || []);
                
                // Handle lead assignment section
                const assignmentSection = document.getElementById('assignmentSection');
                if (window.userPermissions && window.userPermissions.canAssignLeads) {
                    // Show assignment section for admin and accountant
                    assignmentSection.style.display = 'block';
                    
                    // Fetch salesmen list and populate dropdown
                    try {
                        const salesmenResponse = await fetch(`${API_BASE_URL}/admin/salesmen`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (salesmenResponse.ok) {
                            const salesmen = await salesmenResponse.json();
                            const assignedSalesmanSelect = document.getElementById('assignedSalesman');
                            
                            // Clear existing options except "Unassigned"
                            assignedSalesmanSelect.innerHTML = '<option value="">Unassigned</option>';
                            
                            // Add salesmen options
                            salesmen.forEach(salesman => {
                                const option = document.createElement('option');
                                option.value = salesman.id;
                                option.textContent = `${salesman.full_name || salesman.email} (${salesman.email})`;
                                assignedSalesmanSelect.appendChild(option);
                            });
                            
                            // Set current assignment if exists
                            if (contact.assigned_to && contact.assigned_to.id) {
                                assignedSalesmanSelect.value = contact.assigned_to.id;
                            } else {
                                assignedSalesmanSelect.value = '';
                            }
                        }
                    } catch (error) {
                        console.error('Error loading salesmen:', error);
                    }
                } else {
                    // Hide assignment section for other roles
                    assignmentSection.style.display = 'none';
                }
                
                // Show modal
                document.getElementById('contactModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading contact details:', error);
                alert('Error loading contact details');
            }
        }

        function displayContactNotes(notes) {
            const notesList = document.getElementById('contactNotesList');
            
            if (!notes || notes.length === 0) {
                notesList.innerHTML = '<p style="color: #666; font-style: italic;">No notes yet</p>';
                return;
            }
            
            // Sort notes by created_at descending (newest first)
            notes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            notesList.innerHTML = notes.map(note => {
                const noteDate = new Date(note.created_at).toLocaleString();
                return `
                    <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #2E4275;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <strong style="color: #2E4275;">${note.admin_email}</strong>
                            <span style="color: #666; font-size: 12px;">${noteDate}</span>
                        </div>
                        <p style="margin: 0; color: #333;">${note.note_text}</p>
                    </div>
                `;
            }).join('');
        }

        async function updateContactStatus() {
            if (!currentContactId) {
                alert('No contact selected');
                return;
            }
            
            const newStatus = document.getElementById('contactStatusSelect').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/contacts/admin/contacts/${currentContactId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                alert('Status updated successfully!');
                
                // Reload the contact details to show updated timestamp
                await showContactDetail(currentContactId);
                
                // Reload the contacts table
                await loadContacts();
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Error updating status');
            }
        }

        async function addContactNote() {
            if (!currentContactId) {
                alert('No contact selected');
                return;
            }
            
            const noteText = document.getElementById('newNoteText').value.trim();
            
            if (!noteText) {
                alert('Please enter a note');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/contacts/admin/contacts/${currentContactId}/notes`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ note_text: noteText })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const newNote = await response.json();
                
                // Clear the textarea
                document.getElementById('newNoteText').value = '';
                
                // Reload the contact details to show the new note
                await showContactDetail(currentContactId);
            } catch (error) {
                console.error('Error adding note:', error);
                alert('Error adding note');
            }
        }

        function closeContactModal() {
            document.getElementById('contactModal').style.display = 'none';
            currentContactId = null;
        }

        async function assignLead() {
            if (!currentContactId) {
                alert('No contact selected');
                return;
            }
            
            const salesmanId = document.getElementById('assignedSalesman').value;
            
            try {
                if (salesmanId === '') {
                    // Unassign the lead
                    const response = await fetch(`${API_BASE_URL}/admin/leads/${currentContactId}/assign`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    alert('Lead unassigned successfully!');
                } else {
                    // Assign the lead to the selected salesman
                    const response = await fetch(`${API_BASE_URL}/admin/leads/${currentContactId}/assign`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ salesman_id: parseInt(salesmanId) })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    alert('Lead assigned successfully!');
                }
                
                // Reload the contact details to show updated assignment
                await showContactDetail(currentContactId);
                
                // Reload the contacts table
                await loadContacts();
            } catch (error) {
                console.error('Error assigning lead:', error);
                alert('Error assigning lead. Please try again.');
            }
        }


        function showCreateDashboard() { 
            document.getElementById('dashboardModalTitle').textContent = 'Create New Dashboard';
            document.getElementById('dashboardId').value = '';
            document.getElementById('dashboardUserId').value = '';
            document.getElementById('dashboardForm').reset();
            loadUsersForDashboard();
            document.getElementById('dashboardModal').style.display = 'block';
        }
        
        async function loadUsersForDashboard() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                const users = await response.json();
                const select = document.getElementById('dashboardUserSelect');
                
                select.innerHTML = '<option value="">-- Select a user --</option>';
                users.forEach(user => {
                    select.innerHTML += `<option value="${user.id}" data-email="${user.email}" data-name="${user.full_name || 'N/A'}" data-role="${user.role}" data-status="${user.is_active ? 'Active' : 'Inactive'}">${user.email} (${user.full_name || 'No name'})</option>`;
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        function updateDashboardUserInfo() {
            const select = document.getElementById('dashboardUserSelect');
            const selectedOption = select.options[select.selectedIndex];
            const userInfoSection = document.getElementById('userInfoSection');
            
            if (selectedOption.value) {
                document.getElementById('selectedUserEmail').textContent = selectedOption.dataset.email;
                document.getElementById('selectedUserName').textContent = selectedOption.dataset.name;
                document.getElementById('selectedUserRole').textContent = selectedOption.dataset.role;
                document.getElementById('selectedUserStatus').textContent = selectedOption.dataset.status;
                userInfoSection.style.display = 'block';
                document.getElementById('dashboardUserId').value = selectedOption.value;
            } else {
                userInfoSection.style.display = 'none';
                document.getElementById('dashboardUserId').value = '';
            }
        }
        
        function closeDashboardModal() {
            document.getElementById('dashboardModal').style.display = 'none';
        }
        
        // Update URL preview in real-time
        document.addEventListener('DOMContentLoaded', function() {
            const urlInput = document.getElementById('dashboardUrl');
            if (urlInput) {
                urlInput.addEventListener('input', function() {
                    const preview = document.getElementById('urlPreview');
                    if (this.value) {
                        preview.textContent = this.value;
                        preview.style.color = '#333';
                    } else {
                        preview.textContent = 'Enter URL above to see preview';
                        preview.style.color = '#666';
                    }
                });
            }
        });
        
        // Handle dashboard form submission
        document.addEventListener('DOMContentLoaded', function() {
            const dashboardForm = document.getElementById('dashboardForm');
            if (dashboardForm) {
                dashboardForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const userId = document.getElementById('dashboardUserId').value;
                    const url = document.getElementById('dashboardUrl').value;
                    
                    if (!userId || !url) {
                        alert('Please select a user and enter a URL');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/admin/dashboards?user_id=${userId}&looker_studio_url=${encodeURIComponent(url)}`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            alert('Dashboard saved successfully!');
                            closeDashboardModal();
                            await loadDashboards();
                        } else {
                            const error = await response.json();
                            alert('Error: ' + (error.detail || 'Failed to save dashboard'));
                        }
                    } catch (error) {
                        console.error('Error saving dashboard:', error);
                        alert('Error saving dashboard');
                    }
                });
            }
        });
        async function createDashboard(email, url) {
            const usersResponse = await fetch(`${API_BASE_URL}/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } });
            const users = await usersResponse.json(); const user = users.find(u => u.email === email);
            if (!user) { alert('User not found'); return; }
            const response = await fetch(`${API_BASE_URL}/admin/dashboards?user_id=${user.id}&looker_studio_url=${encodeURIComponent(url)}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
            if (response.ok) { alert('Dashboard created!'); await loadDashboards(); } else { alert('Error creating dashboard'); }
        }
        async function editDashboard(userId, currentUrl) { 
            try {
                // Load users and populate the form for editing
                await loadUsersForDashboard();
                
                document.getElementById('dashboardModalTitle').textContent = 'Edit Dashboard';
                document.getElementById('dashboardUserId').value = userId;
                document.getElementById('dashboardUrl').value = currentUrl;
                
                // Select the user in the dropdown
                const select = document.getElementById('dashboardUserSelect');
                select.value = userId;
                updateDashboardUserInfo();
                
                document.getElementById('dashboardModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading dashboard for edit:', error);
                alert('Error loading dashboard data');
            }
        }
        async function toggleUserRole(userId, currentRole) { 
            // Show a prompt to select new role
            const roles = ['user', 'admin', 'salesman', 'accountant', 'technical'];
            const roleLabels = {
                'user': 'Regular User',
                'admin': 'Administrator',
                'salesman': 'Salesman',
                'accountant': 'Accountant',
                'technical': 'Technical'
            };
            
            // Create a simple selection dialog
            const roleOptions = roles.map(role => `${role === currentRole ? '‚úì ' : ''}${roleLabels[role]} (${role})`).join('\n');
            const selection = prompt(`Current role: ${roleLabels[currentRole]}\n\nEnter new role:\n- user\n- admin\n- salesman\n- accountant\n- technical`, currentRole);
            
            if (selection && selection !== currentRole && roles.includes(selection.toLowerCase())) {
                const newRole = selection.toLowerCase();
                await fetch(`${API_BASE_URL}/admin/users/${userId}/role?role=${newRole}`, { 
                    method: 'PUT', 
                    headers: { 'Authorization': `Bearer ${token}` } 
                }); 
                await loadUsers(); 
            } else if (selection && !roles.includes(selection.toLowerCase())) {
                alert('Invalid role. Please enter one of: user, admin, salesman, accountant, technical');
            }
        }
        async function toggleUserStatus(userId, newStatus) { await fetch(`${API_BASE_URL}/admin/users/${userId}/status?is_active=${newStatus}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${token}` } }); await loadUsers(); }
        async function toggleAccessOverride(userId, currentStatus) { if (!confirm(`${!currentStatus ? 'Grant' : 'Remove'} access override?`)) return; await fetch(`${API_BASE_URL}/admin/users/${userId}/access-override?allow_access=${!currentStatus}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${token}` } }); await loadUsers(); }
        async function deleteUser(userId) { if (!confirm('Delete this user?')) return; await fetch(`${API_BASE_URL}/admin/users/${userId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } }); await loadUsers(); await fetchAdminData(); }
        async function toggleBundleStatus(bundleId, newStatus) { await fetch(`${API_BASE_URL}/admin/bundles/${bundleId}?is_active=${newStatus}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${token}` } }); await loadBundles(); }
        function showCreateBundle() { 
            document.getElementById('modalTitle').textContent = 'Create New Bundle';
            document.getElementById('bundleId').value = '';
            document.getElementById('bundleForm').reset();
            document.getElementById('bundleModal').style.display = 'block';
            updatePreview();
        }
        
        function editBundle(bundleId) {
            // Find the bundle data
            fetch(`${API_BASE_URL}/admin/bundles`, { headers: { 'Authorization': `Bearer ${token}` } })
                .then(response => response.json())
                .then(bundles => {
                    const bundle = bundles.find(b => b.id === bundleId);
                    if (!bundle) {
                        alert('Bundle not found');
                        return;
                    }
                    
                    // Populate form
                    document.getElementById('modalTitle').textContent = 'Edit Bundle';
                    document.getElementById('bundleId').value = bundle.id;
                    document.getElementById('bundleName').value = bundle.name;
                    document.getElementById('bundlePrice').value = (bundle.price_cents / 100).toFixed(2);
                    document.getElementById('bundleCurrency').value = bundle.currency;
                    document.getElementById('bundleTier').value = bundle.tier_level;
                    document.getElementById('bundleLogo').value = bundle.logo_type || 'silver';
                    document.getElementById('bundleMainDesc').value = bundle.main_description || '';
                    
                    // Handle description type
                    const predefinedOptions = ['basic-silver', 'upper-gold', 'advanced-diamond'];
                    if (predefinedOptions.includes(bundle.description)) {
                        document.querySelector('input[name="descType"][value="predefined"]').checked = true;
                        document.getElementById('bundleDescPredefined').value = bundle.description;
                    } else {
                        document.querySelector('input[name="descType"][value="custom"]').checked = true;
                        document.getElementById('bundleDescCustom').value = bundle.description || '';
                    }
                    
                    toggleDescriptionType();
                    document.getElementById('bundleModal').style.display = 'block';
                    updatePreview();
                })
                .catch(error => {
                    console.error('Error loading bundle:', error);
                    alert('Error loading bundle data');
                });
        }
        
        function closeBundleModal() {
            document.getElementById('bundleModal').style.display = 'none';
        }
        
        function toggleDescriptionType() {
            const isPredefined = document.querySelector('input[name="descType"][value="predefined"]').checked;
            document.getElementById('predefinedDescGroup').style.display = isPredefined ? 'block' : 'none';
            document.getElementById('customDescGroup').style.display = isPredefined ? 'none' : 'block';
            updatePreview();
        }
        
        async function updatePreview() {
            const logoType = document.getElementById('bundleLogo').value;
            const isPredefined = document.querySelector('input[name="descType"][value="predefined"]').checked;
            const description = isPredefined 
                ? document.getElementById('bundleDescPredefined').value
                : document.getElementById('bundleDescCustom').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/bundle-preview?logo_type=${logoType}&description=${encodeURIComponent(description)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const preview = await response.json();
                
                document.getElementById('svgPreview').innerHTML = preview.svg_html;
                document.getElementById('descriptionPreview').innerHTML = preview.description_html || 'No description';
            } catch (error) {
                console.error('Error updating preview:', error);
                document.getElementById('svgPreview').innerHTML = 'Preview error';
                document.getElementById('descriptionPreview').innerHTML = 'Preview error';
            }
        }
        
        // Handle form submission
        document.getElementById('bundleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const bundleId = document.getElementById('bundleId').value;
            const isEdit = bundleId !== '';
            
            const formData = {
                name: document.getElementById('bundleName').value,
                price_cents: Math.round(parseFloat(document.getElementById('bundlePrice').value) * 100),
                currency: document.getElementById('bundleCurrency').value,
                tier_level: parseInt(document.getElementById('bundleTier').value),
                logo_type: document.getElementById('bundleLogo').value,
                main_description: document.getElementById('bundleMainDesc').value
            };
            
            // Handle description
            const isPredefined = document.querySelector('input[name="descType"][value="predefined"]').checked;
            formData.description = isPredefined 
                ? document.getElementById('bundleDescPredefined').value
                : document.getElementById('bundleDescCustom').value;
            
            try {
                let response;
                if (isEdit) {
                    // Update existing bundle
                    const params = new URLSearchParams(formData);
                    response = await fetch(`${API_BASE_URL}/admin/bundles/${bundleId}?${params}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                } else {
                    // Create new bundle
                    const params = new URLSearchParams(formData);
                    response = await fetch(`${API_BASE_URL}/admin/bundles?${params}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                }
                
                if (response.ok) {
                    alert(isEdit ? 'Bundle updated successfully!' : 'Bundle created successfully!');
                    closeBundleModal();
                    await loadBundles();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to save bundle'));
                }
            } catch (error) {
                console.error('Error saving bundle:', error);
                alert('Error saving bundle');
            }
        });
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const bundleModal = document.getElementById('bundleModal');
            const userModal = document.getElementById('userModal');
            const dashboardModal = document.getElementById('dashboardModal');
            const discountModal = document.getElementById('discountModal');
            const contactModal = document.getElementById('contactModal');
            
            if (event.target === bundleModal) {
                closeBundleModal();
            } else if (event.target === userModal) {
                closeUserModal();
            } else if (event.target === dashboardModal) {
                closeDashboardModal();
            } else if (event.target === discountModal) {
                closeDiscountModal();
            } else if (event.target === contactModal) {
                closeContactModal();
            }
        }
        
        function editUser(userId) {
            // Find the user data
            fetch(`${API_BASE_URL}/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } })
                .then(response => response.json())
                .then(users => {
                    const user = users.find(u => u.id === userId);
                    if (!user) {
                        alert('User not found');
                        return;
                    }
                    
                    // Populate form
                    document.getElementById('userModalTitle').textContent = 'Edit User';
                    document.getElementById('userId').value = user.id;
                    document.getElementById('userEmail').value = user.email;
                    document.getElementById('userFullName').value = user.full_name || '';
                    document.getElementById('userPassword').value = ''; // Don't show existing password
                    document.getElementById('userPassword').placeholder = 'Leave blank to keep current password';
                    document.getElementById('userRole').value = user.role;
                    document.getElementById('userStatus').value = user.is_active.toString();
                    document.getElementById('userAccessOverride').value = (user.allow_access_without_subscription || false).toString();
                    
                    document.getElementById('userModal').style.display = 'block';
                    
                    // Initialize subscription fields visibility based on role
                    toggleSubscriptionFields();
                })
                .catch(error => {
                    console.error('Error loading user:', error);
                    alert('Error loading user data');
                });
        }
        
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }
        
        // Toggle subscription fields based on role
        function toggleSubscriptionFields() {
            const role = document.getElementById('userRole').value;
            const subscriptionFields = document.getElementById('subscriptionFields');
            
            // Only show subscription fields for regular users
            if (role === 'user') {
                subscriptionFields.style.display = 'block';
            } else {
                subscriptionFields.style.display = 'none';
                // Set default values for staff roles
                document.getElementById('userStatus').value = 'true';
                document.getElementById('userAccessOverride').value = 'false';
            }
        }
        
        function showCreateUser() { 
            document.getElementById('userModalTitle').textContent = 'Create New User';
            document.getElementById('userId').value = '';
            document.getElementById('userForm').reset();
            document.getElementById('userModal').style.display = 'block';
            // Initialize subscription fields visibility
            toggleSubscriptionFields();
        }
        document.addEventListener('DOMContentLoaded', function() {
            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const userId = document.getElementById('userId').value;
                    const isEdit = userId !== '';
                    const role = document.getElementById('userRole').value;
                    
                    // Staff roles (admin, salesman, accountant, technical) are always active
                    const isStaffRole = ['admin', 'salesman', 'accountant', 'technical'].includes(role);
                    
                    const formData = {
                        email: document.getElementById('userEmail').value,
                        full_name: document.getElementById('userFullName').value || null,
                        role: role,
                        is_active: isStaffRole ? true : (document.getElementById('userStatus').value === 'true'),
                        allow_access_without_subscription: isStaffRole ? false : (document.getElementById('userAccessOverride').value === 'true')
                    };
                    
                    const password = document.getElementById('userPassword').value;
                    if (password || !isEdit) {
                        if (!password && !isEdit) {
                            alert('Password is required for new users');
                            return;
                        }
                        if (password) {
                            formData.password = password;
                        }
                    }
                    
                    try {
                        let response;
                        if (isEdit) {
                            // Update existing user (multiple API calls for different fields)
                            const promises = [];
                            
                            // Update role
                            promises.push(fetch(`${API_BASE_URL}/admin/users/${userId}/role?role=${formData.role}`, {
                                method: 'PUT',
                                headers: { 'Authorization': `Bearer ${token}` }
                            }));
                            
                            // Update status
                            promises.push(fetch(`${API_BASE_URL}/admin/users/${userId}/status?is_active=${formData.is_active}`, {
                                method: 'PUT',
                                headers: { 'Authorization': `Bearer ${token}` }
                            }));
                            
                            // Update access override
                            promises.push(fetch(`${API_BASE_URL}/admin/users/${userId}/access-override?allow_access=${formData.allow_access_without_subscription}`, {
                                method: 'PUT',
                                headers: { 'Authorization': `Bearer ${token}` }
                            }));
                            
                            const responses = await Promise.all(promises);
                            const allSuccessful = responses.every(r => r.ok);
                            
                            if (allSuccessful) {
                                alert('User updated successfully!');
                            } else {
                                alert('Some updates may have failed. Please check the user data.');
                            }
                        } else {
                            // Create new user
                            const params = new URLSearchParams(formData);
                            response = await fetch(`${API_BASE_URL}/admin/users/create?${params}`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            
                            if (response.ok) {
                                alert('User created successfully!');
                            } else {
                                const error = await response.json();
                                alert('Error: ' + (error.detail || 'Failed to create user'));
                                return;
                            }
                        }
                        
                        closeUserModal();
                        await loadUsers();
                        await fetchAdminData();
                    } catch (error) {
                        console.error('Error saving user:', error);
                        alert('Error saving user');
                    }
                });
            }
        });
        // Role-Based UI Initialization
        function initializeRoleBasedUI(userRole) {
            // Define permission matrix for each role
            const rolePermissions = {
                admin: {
                    showLeads: true,
                    showUsers: true,
                    showDashboards: true,
                    showExport: true,
                    canAssignLeads: true
                },
                accountant: {
                    showLeads: true,
                    showUsers: false,
                    showDashboards: false,
                    showExport: true,
                    canAssignLeads: true
                },
                salesman: {
                    showLeads: true,
                    showUsers: false,
                    showDashboards: false,
                    showExport: false,
                    canAssignLeads: false
                },
                technical: {
                    showLeads: false,
                    showUsers: true,
                    showDashboards: true,
                    showExport: false,
                    canAssignLeads: false
                },
                user: {
                    showLeads: false,
                    showUsers: false,
                    showDashboards: false,
                    showExport: false,
                    canAssignLeads: false
                }
            };
            
            // Get permissions for the current role (default to user if role not found)
            const permissions = rolePermissions[userRole] || rolePermissions.user;
            
            // Show/hide tabs based on permissions
            const leadsTab = document.querySelector('.tab[onclick*="leads"]');
            const usersTab = document.querySelector('.tab[onclick*="users"]');
            const dashboardsTab = document.querySelector('.tab[onclick*="dashboards"]');
            
            if (leadsTab) {
                leadsTab.style.display = permissions.showLeads ? 'block' : 'none';
            }
            if (usersTab) {
                usersTab.style.display = permissions.showUsers ? 'block' : 'none';
            }
            if (dashboardsTab) {
                dashboardsTab.style.display = permissions.showDashboards ? 'block' : 'none';
            }
            
            // Show/hide tab content sections
            const leadsSection = document.getElementById('leads-tab');
            const usersSection = document.getElementById('users-tab');
            const dashboardsSection = document.getElementById('dashboards-tab');
            
            if (leadsSection && !permissions.showLeads) {
                leadsSection.style.display = 'none';
            }
            if (usersSection && !permissions.showUsers) {
                usersSection.style.display = 'none';
            }
            if (dashboardsSection && !permissions.showDashboards) {
                dashboardsSection.style.display = 'none';
            }
            
            // Show/hide export button based on permissions
            const exportButtons = document.querySelectorAll('button[onclick*="exportContacts"]');
            exportButtons.forEach(button => {
                button.style.display = permissions.showExport ? 'inline-block' : 'none';
            });
            
            // Store permissions in window object for later use
            window.userPermissions = permissions;
            
            // Switch to first available tab if current tab is hidden
            if (!permissions.showUsers && currentTab === 'users') {
                if (permissions.showLeads) {
                    switchTabProgrammatically('leads');
                } else if (permissions.showDashboards) {
                    switchTabProgrammatically('dashboards');
                } else {
                    switchTabProgrammatically('subscriptions');
                }
            }
        }
        
        // Helper function to switch tabs programmatically
        function switchTabProgrammatically(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const tabElement = document.querySelector(`.tab[onclick*="${tab}"]`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            const contentElement = document.getElementById(tab + '-tab');
            if (contentElement) {
                contentElement.classList.add('active');
            }
        }
        
        function logout() { localStorage.removeItem('access_token'); window.location.href = 'login.html'; }
        fetchAdminData();

        // ============================================================================
        // BACKUP FUNCTIONS
        // ============================================================================

        async function createBackup() {
            if (!confirm('Create a new database backup?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/backup/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`‚úÖ Backup created successfully!\n\nFilename: ${data.backup.filename}\nSize: ${(data.backup.size_bytes / 1024).toFixed(2)} KB\n\nOld backups cleaned: ${data.cleanup.deleted}`);
                    loadBackups();
                } else {
                    const error = await response.json();
                    alert(`‚ùå Failed to create backup: ${error.detail}`);
                }
            } catch (error) {
                alert(`‚ùå Error creating backup: ${error.message}`);
            }
        }

        async function loadBackups() {
            const backupsList = document.getElementById('backupsList');
            backupsList.innerHTML = '<p style="padding: 40px; text-align: center; color: #999;">Loading backups...</p>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/backup/list`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.backups.length === 0) {
                        backupsList.innerHTML = '<p style="padding: 40px; text-align: center; color: #999;">No backups available</p>';
                        return;
                    }
                    
                    let html = '<table style="width: 100%;"><thead><tr><th style="padding: 12px; text-align: left; background: #f8f9fa; font-weight: 700;">Filename</th><th style="padding: 12px; text-align: left; background: #f8f9fa; font-weight: 700;">Date</th><th style="padding: 12px; text-align: left; background: #f8f9fa; font-weight: 700;">Size</th><th style="padding: 12px; text-align: left; background: #f8f9fa; font-weight: 700;">Actions</th></tr></thead><tbody>';
                    
                    data.backups.forEach((backup, index) => {
                        const sizeKB = (backup.size_bytes / 1024).toFixed(2);
                        const isLatest = index === 0;
                        
                        html += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px;">
                                    ${backup.filename}
                                    ${isLatest ? '<span class="badge badge-success" style="margin-left: 8px;">Latest</span>' : ''}
                                </td>
                                <td style="padding: 12px;">${backup.date}</td>
                                <td style="padding: 12px;">${sizeKB} KB</td>
                                <td style="padding: 12px;">
                                    <button onclick="restoreBackup('${backup.filename}')" class="btn-small btn-warning">
                                        üîÑ Restore
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    backupsList.innerHTML = html;
                } else {
                    backupsList.innerHTML = '<p style="padding: 40px; text-align: center; color: #dc3545;">Failed to load backups</p>';
                }
            } catch (error) {
                backupsList.innerHTML = '<p style="padding: 40px; text-align: center; color: #dc3545;">Error loading backups</p>';
            }
        }

        async function restoreBackup(filename) {
            if (!confirm(`‚ö†Ô∏è WARNING: This will replace your current database with the backup:\n\n${filename}\n\nA safety backup will be created before restore.\n\nAre you sure you want to continue?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/backup/restore/${filename}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`‚úÖ ${data.message}\n\nRestored from: ${filename}\n\nPlease refresh the page or restart the application.`);
                    
                    // Optionally reload the page after a delay
                    setTimeout(() => {
                        if (confirm('Reload the page now?')) {
                            window.location.reload();
                        }
                    }, 2000);
                } else {
                    const error = await response.json();
                    alert(`‚ùå Failed to restore backup: ${error.detail}`);
                }
            } catch (error) {
                alert(`‚ùå Error restoring backup: ${error.message}`);
            }
        }

        // Load backups when backup tab is opened
        document.addEventListener('DOMContentLoaded', function() {
            const backupTab = document.querySelector('.tab[onclick*="backup"]');
            if (backupTab) {
                backupTab.addEventListener('click', function() {
                    loadBackups();
                });
            }
        });
    </script>
</body>
</html>